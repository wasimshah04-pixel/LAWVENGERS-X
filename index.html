<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LAWVENGERS-X</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- START: FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ADDED: FIREBASE MESSAGING SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <!-- END: FIREBASE SDK -->

    <style>
        /* Your existing CSS code here... (কোনো পরিবর্তন নেই) */
        :root {
            --primary-color: #0d1b4c; --secondary-color: #3f51b5; --accent-color: #ffc107;
            --background-color: #f4f6f9; --text-color: #333; --light-text-color: #fff;
            --card-bg: #ffffff; --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        /* ডার্ক মোড ভ্যারিয়েবল */
        body.dark-mode {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #ffc107;
            --background-color: #121212;
            --text-color: #e0e0e0;
            --light-text-color: #ffffff;
            --card-bg: #1e1e1e;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease, color 0.3s ease; }
        
        /* === START: নতুন Splash Screen এর জন্য CSS === */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease-out;
        }
        .splash-content {
            text-align: center;
            color: var(--light-text-color);
            animation: fadeInUp 1.5s ease-out forwards;
        }
        .splash-content h1 {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 2.5em;
            color: var(--accent-color);
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        .splash-content p {
            font-size: 1em;
            opacity: 0.8;
            letter-spacing: 1px;
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* === END: Splash Screen CSS === */

        /* === লগইন স্ক্রিন CSS === */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-container { width: 100%; max-width: 400px; background: var(--card-bg); padding: 30px; border-radius: 20px; box-shadow: var(--shadow); text-align: center; transition: all 0.3s ease; }
        .login-container h2 { color: var(--primary-color); margin-bottom: 25px; }
        .login-container input { width: 100%; padding: 12px 15px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 1em; background: var(--card-bg); color: var(--text-color); transition: all 0.3s ease; }
        .login-container button { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--primary-color); color: var(--light-text-color); font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.3s ease; }
        .login-container .toggle-form { margin-top: 20px; font-size: 0.9em; color: var(--secondary-color); cursor: pointer; transition: color 0.3s ease; }
        #login-error { color: #d32f2f; margin-top: 15px; font-size: 0.9em; }

        #app-container { max-width: 500px; margin: 0 auto; background: var(--background-color); min-height: 100vh; display: none; }
        #app-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--light-text-color); padding: 30px 20px 25px; text-align: center; position: relative; overflow: hidden; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; transition: all 0.3s ease; }
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.15; }
        #app-header .header-top { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; }
        #logout-btn { background: var(--accent-color); color: var(--text-color); border: none; border-radius: 8px; padding: 6px 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        #app-header .main-title { font-family: 'Roboto Condensed', sans-serif; font-size: 2.3em; font-weight: 700; position: relative; z-index: 1; letter-spacing: 2px; margin-bottom: 8px; color: var(--accent-color); }
        #app-header .department, #app-header .university { position: relative; z-index: 1; font-size: 0.85em; font-weight: 300; letter-spacing: 1px; opacity: 0.9; }
        #app-header .department { font-weight: 400; margin-bottom: 4px; }
        main { padding: 20px; }
        .screen { display: none; animation: fadeIn 0.5s ease-in-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #home-screen .welcome-message h2 { font-size: 1.8em; font-weight: 600; }
        .section-title { font-size: 1.4em; font-weight: 600; margin-bottom: 15px; color: var(--primary-color); transition: color 0.3s ease; }
        .latest-updates-container { display: flex; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .latest-updates-container::-webkit-scrollbar { display: none; }
        .update-card { flex: 0 0 280px; background: var(--card-bg); border-radius: 15px; box-shadow: var(--shadow); padding: 15px; margin-right: 15px; border-left: 5px solid var(--accent-color); cursor: pointer; transition: transform 0.2s ease, background-color 0.3s ease; }
        .update-card:hover { transform: translateY(-3px); }
        .update-card h3 { font-size: 1em; margin-bottom: 5px; }
        .update-card p { font-size: 0.85em; color: #666; margin-bottom: 10px; transition: color 0.3s ease; }
        .update-card .date { font-size: 0.75em; color: var(--secondary-color); transition: color 0.3s ease; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .dashboard-card { background: var(--card-bg); border-radius: 15px; box-shadow: var(--shadow); padding: 20px; text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; }
        .dashboard-card:hover, .dashboard-card:active { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); }
        .dashboard-card .icon svg { width: 48px; height: 48px; color: var(--primary-color); transition: color 0.3s ease; }
        .dashboard-card p { font-weight: 600; font-size: 1em; }
        .page-header { display: flex; align-items: center; margin-bottom: 20px; justify-content: space-between; }
        .page-header-title-group { display: flex; align-items: center; }
        .back-btn { background: var(--card-bg); border: none; cursor: pointer; font-size: 1.5em; margin-right: 15px; color: var(--primary-color); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .page-header h2 { font-size: 1.8em; font-weight: 600; }
        .notice-card { background: var(--card-bg); border-radius: 10px; box-shadow: var(--shadow); padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--secondary-color); position: relative; transition: all 0.3s ease; }
        .teacher-card { display: flex; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 15px; position: relative; transition: all 0.3s ease; }
        .teacher-card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid var(--accent-color); }
        .resource-card { display: flex; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 15px; text-decoration: none; color: inherit; position: relative; transition: transform 0.2s ease, background-color 0.3s ease; }
        .resource-card:hover { transform: translateY(-3px); }
        .resource-card .resource-icon { margin-right: 15px; }
        .resource-card .resource-icon svg { width: 36px; height: 36px; color: var(--primary-color); transition: color 0.3s ease; }
        .resource-card .resource-info h3 { font-size: 1.1em; margin-bottom: 3px; }
        .resource-card .resource-info p { font-size: 0.9em; color: #666; transition: color 0.3s ease; }
        
        /* UPGRADED Discussion Hub CSS */
        #discussion-messages-container { 
            height: calc(100vh - 280px); 
            overflow-y: auto; 
            padding: 10px; 
            background: #e9ebee; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            display: flex; 
            flex-direction: column; 
            transition: background-color 0.3s ease; 
        }
        
        .message-bubble {
            position: relative;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            max-width: 85%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            align-self: flex-start;
            word-wrap: break-word;
            transition: background-color 0.3s ease;
        }
        
        .own-message {
            align-self: flex-end;
            background: var(--primary-color);
            color: var(--light-text-color);
        }
        
        .own-message .sender {
            color: var(--accent-color) !important;
        }
        
        .message-actions {
            position: absolute;
            top: 5px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .message-bubble:hover .message-actions {
            opacity: 1;
        }
        
        .message-options-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .own-message .message-options-btn {
            color: var(--light-text-color);
        }
        
        .message-options-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .message-options-menu {
            position: absolute;
            top: 25px;
            right: 0;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 5px 0;
            z-index: 10;
            min-width: 120px;
            display: none;
        }
        
        .message-options-menu.show {
            display: block;
        }
        
        .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .menu-item:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .menu-item.delete {
            color: #d32f2f;
        }
        
        .menu-item.edit {
            color: var(--primary-color);
        }
        
        .edit-message-input {
            width: 100%;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            margin-top: 5px;
        }
        
        .edit-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        /* === START: CODE CORRECTION 1 === */
        .save-inline-edit-btn, .cancel-edit-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .save-inline-edit-btn {
            background: var(--primary-color);
            color: white;
        }
        /* === END: CODE CORRECTION 1 === */
        
        .cancel-edit-btn {
            background: #ccc;
            color: #333;
        }
        
        .edited-badge {
            font-size: 0.7em;
            color: #999;
            font-style: italic;
            margin-left: 5px;
        }
        
        .message-input-container { display: flex; gap: 10px; padding: 8px; background: var(--card-bg); border-radius: 15px; box-shadow: var(--shadow); transition: background-color 0.3s ease; }
        #message-input { flex-grow: 1; border: none; padding: 10px; font-size: 1em; background: transparent; outline: none; color: var(--text-color); }
        #send-message-btn { background: var(--primary-color); color: var(--light-text-color); border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: background-color 0.3s ease; }
        
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .confirmation-modal.show {
            display: flex;
        }
        
        .confirmation-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            text-align: center;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .confirm-btn, .cancel-confirm-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .confirm-btn {
            background: #d32f2f;
            color: white;
        }
        
        .cancel-confirm-btn {
            background: #ccc;
            color: #333;
        }

        .admin-only { display: none; justify-content: center; align-items: center; }
        .admin-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 2; }
        .admin-btn { background: #e0e0e0; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease; }
        .admin-btn.edit-btn { background-color: #ffc107; color: #333; }
        .admin-btn.delete-btn { background-color: #d32f2f; color: white; }
        .add-new-btn { background: var(--primary-color); color: var(--light-text-color); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; box-shadow: var(--shadow); flex-shrink: 0; transition: background-color 0.3s ease; }
        #admin-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        #admin-modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 100%; max-width: 450px; animation: fadeIn 0.3s; transition: background-color 0.3s ease; }
        #admin-modal-content h3 { color: var(--primary-color); margin-bottom: 20px; }
        #admin-form .form-group { margin-bottom: 15px; }
        #admin-form label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: var(--text-color); }
        #admin-form input, #admin-form textarea, #admin-form select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; background: var(--card-bg); color: var(--text-color); transition: all 0.3s ease; }
        #admin-form textarea { resize: vertical; min-height: 80px; }
        #admin-modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        #admin-modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        #save-admin-data-btn { background: var(--primary-color); color: var(--light-text-color); }
        #cancel-admin-modal-btn { background: #eee; color: #333; }
        
        /* ডার্ক মোড টগল বাটন */
        .dark-mode-toggle {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            color: var(--light-text-color);
            transition: transform 0.3s ease;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }
        
        /* সার্চ বার স্টাইল */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .search-bar:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }
        
        /* লোডিং অ্যানিমেশন */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-notice {
            height: 100px;
        }
        
        .skeleton-resource {
            height: 80px;
        }
        
        .skeleton-teacher {
            height: 100px;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        /* ডার্ক মোডে কিছু অতিরিক্ত স্টাইল সামঞ্জস্য */
        body.dark-mode #discussion-messages-container {
            background: #2c2c2c;
        }
        
        body.dark-mode .message-input-container {
            background: #2c2c2c;
        }
        
        body.dark-mode .login-container {
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        body.dark-mode .login-container input {
            background: #2c2c2c;
            color: var(--text-color);
            border-color: #444;
        }
        
        body.dark-mode .admin-btn {
            background: #444;
        }
        
        body.dark-mode .login-container .toggle-form {
            color: var(--accent-color);
        }
        
        body.dark-mode #login-error {
            color: #f44336;
        }
        
        body.dark-mode .update-card .date {
            color: var(--accent-color);
        }
        
        body.dark-mode .resource-card .resource-info p {
            color: #aaa;
        }
        
        body.dark-mode .update-card p {
            color: #aaa;
        }
        
        body.dark-mode #cancel-admin-modal-btn {
            background: #444;
            color: var(--text-color);
        }
        
        body.dark-mode #admin-form input,
        body.dark-mode #admin-form textarea,
        body.dark-mode #admin-form select {
            border-color: #444;
            background: #2c2c2c;
        }
        
        body.dark-mode .search-bar {
            background: #2c2c2c;
            border-color: #444;
            color: var(--text-color);
        }
        
        body.dark-mode .skeleton-loader {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
        }
        
        /* হেডার অ্যাকশনস */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>

    <!-- START: নতুন Splash Screen HTML -->
    <div id="splash-screen">
        <div class="splash-content">
            <h1>LAWVENGERS-X</h1>
            <p>Developed by WASIM SHAH</p>
        </div>
    </div>
    <!-- END: Splash Screen HTML -->

    <!-- === লগইন স্ক্রিন HTML === -->
    <div id="login-screen">
        <div class="login-container">
            <h2 id="form-title">Login</h2>
            <input type="email" id="email-input" placeholder="Email Address" required>
            <input type="password" id="password-input" placeholder="Password" required>
            <button id="auth-btn">Login</button>
            <p id="login-error"></p>
            <p id="toggle-form" class="toggle-form">Don't have an account? Sign Up</p>
        </div>
    </div>

    <div id="app-container">
        <header id="app-header">
            <canvas id="bg-canvas"></canvas>
            <div class="header-top">
                <button id="dark-mode-toggle" class="dark-mode-toggle">🌙</button>
                <h1 class="main-title">LAWVENGERS-X</h1>
                <button id="logout-btn">Logout</button>
            </div>
            <p class="department">DEPARTMENT OF LAW & LAND ADMINISTRATION</p>
            <p class="university">UNIVERSITY OF RAJSHAHI</p>
        </header>

        <main>
            <!-- সকল স্ক্রিন এখানে -->
            <section id="home-screen" class="screen active">
                <div class="welcome-message">
                    <h2 id="user-greeting">Welcome!</h2>
                    <p>Your central hub for all academic updates.</p>
                </div>
                <h3 class="section-title">Latest Updates</h3>
                <div class="latest-updates-container" id="latest-updates"></div>
                <div class="dashboard-grid">
                     <div class="dashboard-card" data-screen="class-notice-screen"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/><path d="M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5H3a.5.5 0 0 1-.5-.5V4z"/></svg></div><p>Class Notice</p></div>
                    <div class="dashboard-card" data-screen="extra-notice-screen"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M12 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM5 4h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1zm0 2h3a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1z"/></svg></div><p>Other Notices</p></div>
                    <div class="dashboard-card" data-screen="resource-screen"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM4.5 12a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7z"/></svg></div><p>Resources</p></div>
                    <div class="dashboard-card" data-screen="teachers-screen"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg></div><p>Teachers' List</p></div>
                    <div class="dashboard-card" data-screen="discussion-hub-screen"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg></div><p>Discussion Hub</p></div>
                </div>
            </section>

            <section id="class-notice-screen" class="screen">
                <div class="page-header">
                    <div class="page-header-title-group">
                        <button class="back-btn" data-screen="home-screen">&#10229;</button>
                        <h2>Class Notices</h2>
                    </div>
                    <div class="header-actions">
                        <button class="add-new-btn admin-only" data-type="notice" data-category="Class">+</button>
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" class="search-bar" id="class-notice-search" placeholder="Search class notices...">
                </div>
                <div id="class-notice-list"></div>
            </section>

            <section id="extra-notice-screen" class="screen">
                <div class="page-header">
                    <div class="page-header-title-group">
                        <button class="back-btn" data-screen="home-screen">&#10229;</button>
                        <h2>Other Notices</h2>
                    </div>
                    <div class="header-actions">
                        <button class="add-new-btn admin-only" data-type="notice" data-category="Other">+</button>
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" class="search-bar" id="extra-notice-search" placeholder="Search other notices...">
                </div>
                <div id="extra-notice-list"></div>
            </section>

            <section id="resource-screen" class="screen">
                <div class="page-header">
                    <div class="page-header-title-group">
                        <button class="back-btn" data-screen="home-screen">&#10229;</button>
                        <h2>Resources</h2>
                    </div>
                    <div class="header-actions">
                        <button class="add-new-btn admin-only" data-type="resource">+</button>
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" class="search-bar" id="resource-search" placeholder="Search resources...">
                </div>
                <div id="resource-list"></div>
            </section>

            <section id="teachers-screen" class="screen">
                <div class="page-header">
                    <div class="page-header-title-group">
                        <button class="back-btn" data-screen="home-screen">&#10229;</button>
                        <h2>Teachers' List</h2>
                    </div>
                    <div class="header-actions">
                        <button class="add-new-btn admin-only" data-type="teacher">+</button>
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" class="search-bar" id="teacher-search" placeholder="Search teachers...">
                </div>
                <div id="teachers-list"></div>
            </section>

            <section id="discussion-hub-screen" class="screen">
                <div class="page-header">
                    <div class="page-header-title-group">
                        <button class="back-btn" data-screen="home-screen">&#10229;</button>
                        <h2>Discussion Hub</h2>
                    </div>
                </div>
                <div id="discussion-messages-container"></div>
                <div class="message-input-container">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button id="send-message-btn">Send</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Confirmation Modal for Delete -->
    <div id="delete-confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <h3>Delete Message</h3>
            <p>Are you sure you want to delete this message?</p>
            <div class="confirmation-buttons">
                <button id="cancel-delete-btn" class="cancel-confirm-btn">Cancel</button>
                <button id="confirm-delete-btn" class="confirm-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- অ্যাডমিনদের জন্য Modal বা পপ-আপ ফরম -->
    <div id="admin-modal">
        <div id="admin-modal-content">
            <h3 id="admin-modal-title">Add/Edit Data</h3>
            <form id="admin-form"></form>
            <div id="admin-modal-buttons">
                <button id="cancel-admin-modal-btn">Cancel</button>
                <button id="save-admin-data-btn">Save</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- START: নতুন Splash Screen এর জন্য JavaScript ---
    const splashScreen = document.getElementById('splash-screen');
    setTimeout(() => {
        splashScreen.classList.add('hidden');
        setTimeout(() => {
            splashScreen.style.display = 'none';
        }, 800);
    }, 2500);
    // --- END: Splash Screen JavaScript ---

    // --- ডার্ক মোড টগল ফাংশনালিটি ---
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const currentTheme = localStorage.getItem('darkMode');
    if (currentTheme === 'enabled') {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '☀️';
    }

    function updateThreeJSColor(isDarkMode) {
        if (window.shapeMaterial) {
            window.shapeMaterial.color.set(isDarkMode ? 0x666666 : 0xffffff);
        }
    }

    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        darkModeToggle.textContent = isDarkMode ? '☀️' : '🌙';
        updateThreeJSColor(isDarkMode);
    });

    // --- Firebase কনফিগারেশন ---
    const firebaseConfig = {
      apiKey: "AIzaSyCGEhtOC5B8MyPffRmpyvBf0NlEJU1tvuY",
      authDomain: "lawvengers-x.firebaseapp.com",
      databaseURL: "https://lawvengers-x-default-rtdb.firebaseio.com",
      projectId: "lawvengers-x",
      storageBucket: "lawvengers-x.appspot.com",
      messagingSenderId: "136620412563",
      appId: "1:136620412563:web:7d211309140d5d1dacc766"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const database = firebase.database();
    // ADDED: Initialize Firebase Messaging
    const messaging = firebase.messaging();

    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const authBtn = document.getElementById('auth-btn');
    const toggleFormBtn = document.getElementById('toggle-form');
    const formTitle = document.getElementById('form-title');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');
    const userGreeting = document.getElementById('user-greeting');
    const latestUpdatesContainer = document.getElementById('latest-updates');
    
    const adminModal = document.getElementById('admin-modal');
    const adminModalTitle = document.getElementById('admin-modal-title');
    const adminForm = document.getElementById('admin-form');
    const saveAdminDataBtn = document.getElementById('save-admin-data-btn');
    const cancelAdminModalBtn = document.getElementById('cancel-admin-modal-btn');

    const classNoticeSearch = document.getElementById('class-notice-search');
    const extraNoticeSearch = document.getElementById('extra-notice-search');
    const resourceSearch = document.getElementById('resource-search');
    const teacherSearch = document.getElementById('teacher-search');

    const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    let isLoginMode = true;
    let currentUserIsAdmin = false;
    let currentUser = null;
    let messageToDelete = null;

    let allClassNotices = [];
    let allExtraNotices = [];
    let allResources = [];
    let allTeachers = [];

    toggleFormBtn.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        formTitle.textContent = isLoginMode ? 'Login' : 'Sign Up';
        authBtn.textContent = isLoginMode ? 'Login' : 'Sign Up';
        toggleFormBtn.textContent = isLoginMode ? "Don't have an account? Sign Up" : "Already have an account? Login";
        loginError.textContent = '';
    });

    authBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
            loginError.textContent = "Please enter both email and password.";
            return;
        }

        loginError.textContent = '';
        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => loginError.textContent = error.message);
        } else {
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => loginError.textContent = error.message);
        }
    });
    
    // --- START: NOTIFICATION LOGIC ---
    function setupNotifications(user) {
        // IMPORTANT: Replace with your VAPID key from Firebase Console
        const vapidKey = "BGohImLC-1HAsveI0LXFlI37DzaAlPd4Sq1Uwq2BXBcsKjvgzz-OrH4twHLQS-thzi9pqCeT82G1BzJXN1PKJog";
        
        messaging.getToken({ vapidKey: vapidKey }).then((currentToken) => {
            if (currentToken) {
                // Save the token to the database
                console.log('FCM Token:', currentToken);
                database.ref('fcm_tokens/' + user.uid).set(currentToken);
            } else {
                console.log('No registration token available. Request permission to generate one.');
                requestNotificationPermission(user);
            }
        }).catch((err) => {
            console.log('An error occurred while retrieving token. ', err);
        });
    }

    function requestNotificationPermission(user) {
        console.log('Requesting permission...');
        Notification.requestPermission().then((permission) => {
            if (permission === 'granted') {
                console.log('Notification permission granted.');
                setupNotifications(user);
            } else {
                console.log('Unable to get permission to notify.');
            }
        });
    }

    // Handle incoming messages when the app is in the foreground
    messaging.onMessage((payload) => {
        console.log('Message received. ', payload);
        alert(`New Update:\n${payload.notification.title}`);
    });
    // --- END: NOTIFICATION LOGIC ---


    logoutBtn.addEventListener('click', () => {
        // Remove the user's token on logout
        if(currentUser) {
            database.ref('fcm_tokens/' + currentUser.uid).remove();
        }
        auth.signOut();
        currentUserIsAdmin = false;
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'block';
            userGreeting.textContent = `Welcome, ${user.email.split('@')[0]}`;
            currentUser = user;
            
            // ADDED: Setup notifications on login
            requestNotificationPermission(user);

            database.ref(`admins/${user.uid}`).once('value', snapshot => {
                currentUserIsAdmin = snapshot.exists();
                toggleAdminUI(currentUserIsAdmin);
                initializeAppLogic(user);
            });

        } else {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            toggleAdminUI(false);
            currentUser = null;
        }
    });
    
    function toggleAdminUI(isAdmin) {
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? 'flex' : 'none';
        });
    }

    const screens = document.querySelectorAll('.screen');
    function showScreen(screenId) {
        window.scrollTo(0, 0);
        screens.forEach(screen => screen.classList.remove('active'));
        document.getElementById(screenId)?.classList.add('active');
    }
    
    function initializeAppLogic(currentUser) {
        try {
            const header = document.getElementById('app-header');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, header.offsetWidth / header.offsetHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
            renderer.setSize(header.offsetWidth, header.offsetHeight);
            const geometry = new THREE.TorusKnotGeometry( 0.8, 0.25, 100, 16 );
            const material = new THREE.MeshStandardMaterial({ 
                color: document.body.classList.contains('dark-mode') ? 0x666666 : 0xffffff, 
                roughness: 0.5, 
                metalness: 0.7 
            });
            window.shapeMaterial = material;
            const shape = new THREE.Mesh(geometry, material);
            scene.add(shape);
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 0.7); pointLight.position.set(5, 5, 5); scene.add(pointLight);
            camera.position.z = 3;
            function animateHeader() {
                requestAnimationFrame(animateHeader);
                shape.rotation.x += 0.002; shape.rotation.y += 0.002;
                renderer.render(scene, camera);
            }
            animateHeader();
        } catch (e) { console.error("Three.js failed", e); }

        const navButtons = document.querySelectorAll('.dashboard-card, .back-btn');
        navButtons.forEach(button => button.addEventListener('click', () => showScreen(button.dataset.screen)));

        classNoticeSearch.addEventListener('input', () => filterNotices('class'));
        extraNoticeSearch.addEventListener('input', () => filterNotices('extra'));
        resourceSearch.addEventListener('input', filterResources);
        teacherSearch.addEventListener('input', filterTeachers);

        function populateNotices() {
            const noticesRef = database.ref('notices').orderByChild('timestamp');
            
            document.getElementById('class-notice-list').innerHTML = `<div class="skeleton-loader skeleton-notice"></div>`.repeat(3);
            document.getElementById('extra-notice-list').innerHTML = `<div class="skeleton-loader skeleton-notice"></div>`.repeat(2);
            
            noticesRef.on('value', (snapshot) => {
                allClassNotices = [];
                allExtraNotices = [];

                const allNotices = [];
                snapshot.forEach(childSnapshot => {
                    const noticeData = childSnapshot.val();
                    if (noticeData) {
                        allNotices.push({ key: childSnapshot.key, ...noticeData });
                    }
                });

                allNotices.reverse();

                latestUpdatesContainer.innerHTML = allNotices.slice(0, 5).map(notice => `
                    <div class="update-card" data-notice-id="${notice.key}" data-notice-type="${notice.type || 'Other'}">
                        <h3>${notice.title || 'No Title'}</h3>
                        <p>${(notice.content || '').substring(0, 50)}...</p>
                        <div class="date">${notice.date || 'No Date'}</div>
                    </div>`).join('');
                
                allNotices.forEach(notice => {
                    const adminButtons = currentUserIsAdmin ? `
                        <div class="admin-controls">
                            <button class="admin-btn edit-btn" data-type="notice" data-key="${notice.key}">✎</button>
                            <button class="admin-btn delete-btn" data-type="notice" data-key="${notice.key}">🗑</button>
                        </div>` : '';

                    const noticeCardHTML = `<div class="notice-card" id="notice-${notice.key}">
                        ${adminButtons}
                        <h3 class="notice-title">${notice.title || 'No Title'}</h3>
                        <p class="notice-date">${notice.date || 'No Date'}</p>
                        <p class="notice-content">${notice.content || 'No Content'}</p>
                    </div>`;

                    if (notice.type === 'Class') {
                        allClassNotices.push({ key: notice.key, element: noticeCardHTML, title: (notice.title || '').toLowerCase(), content: (notice.content || '').toLowerCase(), date: (notice.date || '').toLowerCase() });
                    } else {
                        allExtraNotices.push({ key: notice.key, element: noticeCardHTML, title: (notice.title || '').toLowerCase(), content: (notice.content || '').toLowerCase(), date: (notice.date || '').toLowerCase() });
                    }
                });

                displayFilteredNotices('class', allClassNotices);
                displayFilteredNotices('extra', allExtraNotices);
            });
        }
        
        function populateResources() {
            const resourcesRef = database.ref('resources').orderByChild('timestamp');
            document.getElementById('resource-list').innerHTML = `<div class="skeleton-loader skeleton-resource"></div>`.repeat(3);
            
            resourcesRef.on('value', snapshot => {
                allResources = [];
                if (!snapshot.exists()) {
                    document.getElementById('resource-list').innerHTML = '<p>No resources available.</p>';
                    return;
                }
                
                snapshot.forEach(childSnapshot => {
                    const resourceData = childSnapshot.val();
                    if (resourceData) {
                        const resource = { key: childSnapshot.key, ...resourceData };
                        const adminButtons = currentUserIsAdmin ? `<div class="admin-controls"><button class="admin-btn edit-btn" data-type="resource" data-key="${resource.key}">✎</button><button class="admin-btn delete-btn" data-type="resource" data-key="${resource.key}">🗑</button></div>` : '';
                        const resourceCardHTML = `<div style="position: relative;">${adminButtons}<a href="${resource.url || '#'}" target="_blank" class="resource-card"><div class="resource-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 0h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H4z"/><path d="M4.5 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z"/></svg></div><div class="resource-info"><h3>${resource.title || 'No Title'}</h3><p>${resource.description || 'No Description'}</p></div></a></div>`;
                        allResources.push({ key: resource.key, element: resourceCardHTML, title: (resource.title || '').toLowerCase(), description: (resource.description || '').toLowerCase() });
                    }
                });
                displayFilteredResources(allResources);
            });
        }

        function populateTeachers() {
            const teachersRef = database.ref('teachers');
            document.getElementById('teachers-list').innerHTML = `<div class="skeleton-loader skeleton-teacher"></div>`.repeat(3);
            
            teachersRef.on('value', snapshot => {
                allTeachers = [];
                snapshot.forEach(childSnapshot => {
                    const teacherData = childSnapshot.val();
                    if (teacherData) {
                        const teacher = { key: childSnapshot.key, ...teacherData };
                        const adminButtons = currentUserIsAdmin ? `<div class="admin-controls"><button class="admin-btn edit-btn" data-type="teacher" data-key="${teacher.key}">✎</button><button class="admin-btn delete-btn" data-type="teacher" data-key="${teacher.key}">🗑</button></div>` : '';
                        const teacherCardHTML = `<div class="teacher-card">${adminButtons}<img src="${teacher.img || 'https://via.placeholder.com/70'}" alt="${teacher.name || 'Teacher'}"><div class="teacher-info"><h3>${teacher.name || 'No Name'}</h3><p>${teacher.designation || 'No Designation'}</p><div class="contact-details"><span>✉️ ${teacher.email || 'No Email'}</span><br><span>📞 ${teacher.phone || 'No Phone'}</span></div></div></div>`;
                        allTeachers.push({ key: teacher.key, element: teacherCardHTML, name: (teacher.name || '').toLowerCase(), designation: (teacher.designation || '').toLowerCase(), email: (teacher.email || '').toLowerCase() });
                    }
                });
                displayFilteredTeachers(allTeachers);
            });
        }

        function filterNotices(type) {
            const searchTerm = (type === 'class' ? classNoticeSearch.value : extraNoticeSearch.value).toLowerCase();
            const notices = type === 'class' ? allClassNotices : allExtraNotices;
            const filtered = searchTerm ? notices.filter(n => (n.title || '').includes(searchTerm) || (n.content || '').includes(searchTerm) || (n.date || '').includes(searchTerm)) : notices;
            displayFilteredNotices(type, filtered);
        }
        
        function displayFilteredNotices(type, notices) {
            const container = type === 'class' ? document.getElementById('class-notice-list') : document.getElementById('extra-notice-list');
            container.innerHTML = notices.length === 0 ? '<div class="no-results">No notices found.</div>' : notices.map(n => n.element).join('');
        }
        
        function filterResources() {
            const searchTerm = resourceSearch.value.toLowerCase();
            const filtered = searchTerm ? allResources.filter(r => (r.title || '').includes(searchTerm) || (r.description || '').includes(searchTerm)) : allResources;
            displayFilteredResources(filtered);
        }
        
        function displayFilteredResources(resources) {
            const container = document.getElementById('resource-list');
            container.innerHTML = resources.length === 0 ? '<div class="no-results">No resources found.</div>' : resources.map(r => r.element).join('');
        }
        
        function filterTeachers() {
            const searchTerm = teacherSearch.value.toLowerCase();
            const filtered = searchTerm ? allTeachers.filter(t => (t.name || '').includes(searchTerm) || (t.designation || '').includes(searchTerm) || (t.email || '').includes(searchTerm)) : allTeachers;
            displayFilteredTeachers(filtered);
        }
        
        function displayFilteredTeachers(teachers) {
            const container = document.getElementById('teachers-list');
            container.innerHTML = teachers.length === 0 ? '<div class="no-results">No teachers found.</div>' : teachers.map(t => t.element).join('');
        }

        // --- CORRECTED Discussion Hub Functions ---
        const discussionRef = database.ref('discussions');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const messagesContainer = document.getElementById('discussion-messages-container');

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText && currentUser) {
                discussionRef.push({
                    sender: currentUser.email.split('@')[0],
                    senderId: currentUser.uid,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    edited: false
                });
                messageInput.value = '';
            }
        }

        function listenForMessages() {
            messagesContainer.innerHTML = ''; // Clear previous messages
            const discussionQuery = discussionRef.limitToLast(50);

            // 1. For new messages being added
            discussionQuery.on('child_added', (snapshot) => {
                const message = snapshot.val();
                const messageKey = snapshot.key;
                displayMessage(message, messageKey);
                // Auto-scroll to the bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });

            // 2. For messages being changed (edited)
            discussionQuery.on('child_changed', (snapshot) => {
                const updatedMessage = snapshot.val();
                const messageKey = snapshot.key;
                const messageElement = document.getElementById(`message-${messageKey}`);
                if (messageElement) {
                    const textElement = messageElement.querySelector('.text');
                    const timestampElement = messageElement.querySelector('.timestamp');
                    
                    if (textElement) textElement.textContent = updatedMessage.text;
                    if (timestampElement) {
                        const sentTime = new Date(updatedMessage.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const editedBadge = updatedMessage.edited ? '<span class="edited-badge">(edited)</span>' : '';
                        timestampElement.innerHTML = `${sentTime} ${editedBadge}`;
                    }
                }
            });

            // 3. For messages being removed
            discussionQuery.on('child_removed', (snapshot) => {
                const messageKey = snapshot.key;
                const messageElement = document.getElementById(`message-${messageKey}`);
                if (messageElement) {
                    messageElement.remove();
                }
            });
        }

        function displayMessage(message, messageKey) {
            // Avoid displaying null messages
            if (!message) return;

            const sentTime = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isOwnMessage = message.senderId === currentUser.uid;
            const messageClass = isOwnMessage ? 'message-bubble own-message' : 'message-bubble';
            const editedBadge = message.edited ? '<span class="edited-badge">(edited)</span>' : '';
            
            const messageHTML = `
                <div class="${messageClass}" id="message-${messageKey}">
                    <div class="message-actions">
                        <button class="message-options-btn" onclick="toggleMessageOptions('${messageKey}')">⋯</button>
                        <div class="message-options-menu" id="options-${messageKey}">
                            ${isOwnMessage ? `<div class="menu-item edit" onclick="startEditMessage('${messageKey}')"><span>✎ Edit</span></div>` : ''}
                            ${(isOwnMessage || currentUserIsAdmin) ? `<div class="menu-item delete" onclick="confirmDeleteMessage('${messageKey}')"><span>🗑 Delete</span></div>` : ''}
                        </div>
                    </div>
                    <div class="sender">${message.sender}</div>
                    <div class="text" id="text-${messageKey}">${message.text}</div>
                    <span class="timestamp">${sentTime} ${editedBadge}</span>
                </div>
            `;
            
            messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        }

        window.editMessage = function(messageKey, newText) {
            if (!newText.trim()) return;
            database.ref(`discussions/${messageKey}`).update({
                text: newText.trim(),
                edited: true
            }).catch(err => console.error("Message edit failed:", err));
        }

        window.deleteMessage = function(messageKey) {
            database.ref(`discussions/${messageKey}`).remove()
            .catch(err => console.error("Message delete failed:", err));
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') sendMessage(); 
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (messageToDelete) {
                deleteMessage(messageToDelete);
                messageToDelete = null;
            }
            deleteConfirmationModal.classList.remove('show');
        });

        cancelDeleteBtn.addEventListener('click', () => {
            messageToDelete = null;
            deleteConfirmationModal.classList.remove('show');
        });
        
        deleteConfirmationModal.addEventListener('click', (e) => {
            if (e.target === deleteConfirmationModal) {
                messageToDelete = null;
                deleteConfirmationModal.classList.remove('show');
            }
        });

        populateNotices();
        populateResources();
        populateTeachers();
        listenForMessages(); // Initialize the corrected message listener
    }
    
    let currentEditing = { type: null, key: null };

    function openAdminModal(type, key = null, category = null) {
        currentEditing = { type, key };
        adminForm.innerHTML = '';
        let formHTML = '';
        let modalTitle = '';

        if (type === 'notice') {
            modalTitle = key ? 'Edit Notice' : 'Add New Notice';
            formHTML = `
                <input type="hidden" id="notice-type-input" value="${category || 'Other'}">
                <div class="form-group"><label for="title-input">Title</label><input type="text" id="title-input" required></div>
                <div class="form-group"><label for="content-input">Content</label><textarea id="content-input" required></textarea></div>`;
        } else if (type === 'teacher') {
            modalTitle = key ? 'Edit Teacher Info' : 'Add New Teacher';
            formHTML = `
                <div class="form-group"><label for="teacher-name">Name</label><input type="text" id="teacher-name" required></div>
                <div class="form-group"><label for="teacher-designation">Designation</label><input type="text" id="teacher-designation" required></div>
                <div class="form-group"><label for="teacher-email">Email</label><input type="email" id="teacher-email" required></div>
                <div class="form-group"><label for="teacher-phone">Phone</label><input type="tel" id="teacher-phone" required></div>
                <div class="form-group"><label for="teacher-img">Image URL</label><input type="text" id="teacher-img" required></div>`;
        } else if (type === 'resource') {
            modalTitle = key ? 'Edit Resource' : 'Add New Resource';
            formHTML = `
                <div class="form-group"><label for="title-input">Title</label><input type="text" id="title-input" required></div>
                <div class="form-group"><label for="description-input">Description</label><textarea id="description-input" required></textarea></div>
                <div class="form-group"><label for="url-input">Resource URL</label><input type="text" id="url-input" required></div>`;
        }

        adminModalTitle.textContent = modalTitle;
        adminForm.innerHTML = formHTML;

        if (key) {
            database.ref(`${type}s/${key}`).once('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    if (type === 'notice') {
                        document.getElementById('title-input').value = data.title || '';
                        document.getElementById('content-input').value = data.content || '';
                        document.getElementById('notice-type-input').value = data.type || 'Other';
                    } else if (type === 'teacher') {
                        document.getElementById('teacher-name').value = data.name || '';
                        document.getElementById('teacher-designation').value = data.designation || '';
                        document.getElementById('teacher-email').value = data.email || '';
                        document.getElementById('teacher-phone').value = data.phone || '';
                        document.getElementById('teacher-img').value = data.img || '';
                    } else if (type === 'resource') {
                        document.getElementById('title-input').value = data.title || '';
                        document.getElementById('description-input').value = data.description || '';
                        document.getElementById('url-input').value = data.url || '';
                    }
                }
            });
        }
        adminModal.style.display = 'flex';
    }

    function closeAdminModal() { adminModal.style.display = 'none'; }

    function saveAdminData() {
        const { type, key } = currentEditing;
        let data = {};
        const dataRef = database.ref(`${type}s`);

        if (type === 'notice') {
            data = { title: document.getElementById('title-input').value.trim(), content: document.getElementById('content-input').value.trim(), date: new Date().toLocaleDateString('en-CA'), timestamp: firebase.database.ServerValue.TIMESTAMP, type: document.getElementById('notice-type-input').value };
            if (!data.title || !data.content) { alert("Title and Content are required."); return; }
        } else if (type === 'teacher') {
            data = { name: document.getElementById('teacher-name').value.trim(), designation: document.getElementById('teacher-designation').value.trim(), email: document.getElementById('teacher-email').value.trim(), phone: document.getElementById('teacher-phone').value.trim(), img: document.getElementById('teacher-img').value.trim() };
            if (!data.name || !data.designation) { alert("Name and Designation are required."); return; }
        } else if (type === 'resource') {
            data = { title: document.getElementById('title-input').value.trim(), description: document.getElementById('description-input').value.trim(), url: document.getElementById('url-input').value.trim(), timestamp: firebase.database.ServerValue.TIMESTAMP };
            if (!data.title || !data.url) { alert("Title and URL are required."); return; }
        }

        const promise = key ? dataRef.child(key).update(data) : dataRef.push(data);
        promise.then(closeAdminModal).catch(err => alert(err.message));
    }

    function deleteData(type, key) {
        if (confirm('Are you sure you want to delete this item?')) {
            database.ref(`${type}s/${key}`).remove().catch(err => alert(err.message));
        }
    }

    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('.add-new-btn, .edit-btn, .delete-btn');
        if (!target) return;

        const { type, key, category } = target.dataset;

        if (target.classList.contains('add-new-btn')) openAdminModal(type, null, category);
        if (target.classList.contains('edit-btn')) openAdminModal(type, key);
        if (target.classList.contains('delete-btn')) deleteData(type, key);
    });

    saveAdminDataBtn.addEventListener('click', saveAdminData);
    cancelAdminModalBtn.addEventListener('click', closeAdminModal);
    
    latestUpdatesContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.update-card');
        if (!card) return;
        const { noticeId, noticeType } = card.dataset;
        showScreen(noticeType === 'Class' ? 'class-notice-screen' : 'extra-notice-screen');
        setTimeout(() => {
            const targetNotice = document.getElementById(`notice-${noticeId}`);
            if (targetNotice) {
                targetNotice.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetNotice.style.transition = 'background-color 0.5s';
                targetNotice.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
                setTimeout(() => { targetNotice.style.backgroundColor = ''; }, 1500);
            }
        }, 300);
    });

    // Global functions for message actions
    window.toggleMessageOptions = function(messageKey) {
        document.querySelectorAll('.message-options-menu').forEach(menu => {
            if (menu.id !== `options-${messageKey}`) menu.classList.remove('show');
        });
        document.getElementById(`options-${messageKey}`)?.classList.toggle('show');
    }

    let originalMessageText = '';
    window.startEditMessage = function(messageKey) {
        const textElement = document.getElementById(`text-${messageKey}`);
        originalMessageText = textElement.textContent;
        // === START: CODE CORRECTION 2 ===
        textElement.innerHTML = `<textarea class="edit-message-input">${originalMessageText}</textarea><div class="edit-actions"><button class="save-inline-edit-btn" onclick="saveEditedMessage('${messageKey}')">Save</button><button class="cancel-edit-btn" onclick="cancelEditMessage('${messageKey}')">Cancel</button></div>`;
        // === END: CODE CORRECTION 2 ===
        document.getElementById(`options-${messageKey}`)?.classList.remove('show');
    }

    window.saveEditedMessage = function(messageKey) {
        const textElement = document.getElementById(`text-${messageKey}`);
        const textarea = textElement.querySelector('.edit-message-input');
        editMessage(messageKey, textarea.value);
    }

    window.cancelEditMessage = function(messageKey) {
        const textElement = document.getElementById(`text-${messageKey}`);
        textElement.innerHTML = originalMessageText; // Restore from variable
    }

    window.confirmDeleteMessage = function(messageKey) {
        messageToDelete = messageKey;
        deleteConfirmationModal.classList.add('show');
        document.getElementById(`options-${messageKey}`)?.classList.remove('show');
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.message-options-btn') && !e.target.closest('.message-options-menu')) {
            document.querySelectorAll('.message-options-menu').forEach(menu => menu.classList.remove('show'));
        }
    });

});
</script>

</body>
</html>
